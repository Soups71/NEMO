# NMEA2000 Protocol

## What's NMEA2000?

NMEA2000 (also written N2K) is the communication standard that boats use for connecting sensors, displays, and control systems. Think of it as the marine equivalent of your car's internal network - it lets the GPS talk to the chartplotter, the depth sounder share data with the autopilot, and the engine computer report status to the helm display.

The protocol comes from the National Marine Electronics Association (NMEA), the same organization behind the older NMEA 0183 standard.

## NMEA 0183 vs NMEA2000

If you've messed with marine electronics before, you probably hit NMEA 0183 first. It spits out human-readable sentences like:

```
$GPGGA,123519,4807.038,N,01131.000,E,1,08,0.9,545.4,M,47.0,M,,*47
```

0183 worked fine for decades, but it's got issues:
- Slow (4,800 baud, sometimes 38,400)
- Point-to-point wiring
- No standard connector
- ASCII text only

NMEA2000 fixes these:

| Thing | NMEA 0183 | NMEA2000 |
|-------|-----------|----------|
| Speed | 4,800-38,400 baud | 250,000 baud |
| Topology | Point-to-point | Multi-drop bus |
| Connector | Whatever | Standardized 5-pin connector |
| Format | ASCII text | Binary |
| Power | Separate | On the network cable |

## Under the Hood

NMEA2000 is built on existing standards:

1. **Physical Layer**: CAN bus at 250 kbps
2. **Data Link Layer**: ISO 11783-3 (also used in tractors, fun fact)
3. **Network Layer**: ISO 11783-5 for address management
4. **Application Layer**: NMEA's Parameter Group Numbers (PGNs)

This means NMEA2000 devices use off-the-shelf CAN chips. The interesting stuff is in the protocol on top.

## Addressing and Identity

Every device needs a unique source address (0-251). But addresses aren't hardcoded - NMEA2000 uses dynamic claiming based on ISO 11783.

Each device has a 64-bit NAME that uniquely identifies it:

| Field | Bits | What |
|-------|------|------|
| Identity Number | 21 | Serial number from manufacturer |
| Manufacturer Code | 11 | Assigned by NMEA |
| Device Instance | 3 | Distinguishes multiples of same device |
| Device Function | 8 | What it does |
| Device Class | 7 | Category |
| System Instance | 4 | For complex installs |
| Industry Group | 3 | Marine = 4 |
| Self-Configurable | 1 | Always 1 for N2K |

When a device powers on, it broadcasts its NAME to claim an address using the 60928 PGN. If two devices want the same address, the one with the numerically lower NAME wins. Loser picks a different address.

**This is the key to the DOS attack**: NAME determines priority. A device with a lower NAME can kick any higher-NAME device off its address.

## Parameter Group Numbers (PGNs)

Data in NMEA2000 comes in Parameter Groups, each with a PGN. Think of PGNs as message types. Common ones:

| PGN | Name | What It Carries |
|-----|------|-----------------|
| 60928 | ISO Address Claim | Device identity broadcast |
| 126992 | System Time | Date and time |
| 127250 | Vessel Heading | Compass heading |
| 127488 | Engine Parameters, Rapid | RPM, boost pressure |
| 128259 | Speed, Water Referenced | Speed through water |
| 128267 | Water Depth | Depth below transducer |
| 129025 | Position, Rapid Update | Lat/long |
| 129026 | COG & SOG | Course and speed over ground |
| 130306 | Wind Data | Wind speed and angle |

NMEA sells the complete PGN database, but many common ones are documented through reverse engineering and the open source library community.

Shoutout to CANBOAT project for doing a ton of the heavy lifting. Check them out here: [CANBOAT](https://canboat.github.io/canboat/canboat.html)

## Message Structure

NMEA2000 packs data into CAN frames. The 29-bit identifier encodes:

- Priority (3 bits): 0-7, lower = higher priority
- PGN (18 bits): The parameter group number
- Source Address (8 bits): Who sent it

Data fields use standardized formats:
- Temperatures in 0.01 Kelvin
- Angles in radians Ã— 10,000
- Distances in 0.01 meters
- Speed in 0.01 m/s

The library handles conversions, but knowing raw formats helps when analyzing traffic.

## Fast Packets

Some data doesn't fit in 8 bytes. For these, NMEA2000 uses "fast packet" messages spanning multiple frames. 

Fast packets include sequence and frame counters so receivers can reassemble the complete message.

## Network Layout

A typical network consists of all of devices connecting to one backbone. 

The backbone is a trunk cable with T-connectors for each device. Termination resistors cap each end. Power can flow through the network or come in separately for hungry devices.

Max length is around 100 meters for the backbone with 6-meter drops.

## The Security Problem

NMEA2000 inherits CAN's trust model: any device can send any message. Combined with address claiming, this creates attack vectors:

1. **Spoofing**: Send fake sensor data (false GPS, wrong depth)
2. **Denial of Service**: Flood the bus with high-priority garbage
3. **Impersonation**: Pretend to be a specific device

There's no cryptographic authentication. A device can't verify that a message actually came from the claimed source. No integrity protection beyond basic CRC error checking.

This wasn't an oversight - it reflects the threat model of the 90s when the protocol was designed. "Network security" meant physical access control: only trusted devices get plugged in.

That assumption increasingly fails as:
- WiFi gateways get added for monitoring
- USB and Bluetooth adapters provide diagnostic access
- Aftermarket devices from sketchy sources get installed
- Charter boats have random users



## NEMO Implementation

NEMO implements NMEA2000 using the Teensy 4.0's dual FlexCAN controllers and the NMEA2000 library. Here's how it all fits together.


### Multi-Device Mode

NEMO simulates up to three independent NMEA2000 devices on CAN1. Each gets its own:
- Source address (starting at 22)
- Device NAME (64-bit unique ID)
- Product information
- Heartbeat interval


### Supported PGNs

NEMO generates and parses these (defined in `constants.h`):

| PGN | Name | NEMO Use |
|-----|------|----------|
| 60928 | ISO Address Claim | Identity, attack target |
| 126993 | Heartbeat | Device presence |
| 126996 | Product Information | Name extraction |
| 127245 | Rudder | Simulate/spoof |
| 127250 | Vessel Heading | Simulate/spoof |
| 127488 | Engine RPM | Simulate/spoof |
| 127489 | Engine Parameters | Spoof only |
| 127505 | Fluid Level | Simulate/spoof |
| 127508 | Battery Status | Simulate/spoof |
| 128259 | Speed, Water | Simulate/spoof |
| 128267 | Water Depth | Simulate/spoof |
| 129025 | Position | Spoof only |
| 129026 | COG & SOG | Spoof only |
| 130306 | Wind Data | Simulate/spoof |
| 130310-130316 | Environmental | Simulate/spoof |



For the full code breakdown, see [Source Code Architecture](Source_Code_Architecture.md).



## More Reading

- [NMEA 2000 Explained](https://www.nmea.org/nmea-2000.html) - Official NMEA overview
- [OpenSkipper NMEA2000 Documentation](http://openskipper.org/) - Open source notes
- [CANboat](https://github.com/canboat/canboat) - PGN docs and analysis tools
- [NMEA2000 Library](https://github.com/ttlappalainen/NMEA2000) - The NMEA2000 Library used
- [Full NMEA2000 Breakdown](https://www.csselectronics.com/pages/nmea-2000-n2k-intro-tutorial)